<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title | default: site.title }}</title>
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <!-- Preload critical fonts -->
    <link rel="preload" href="{{ '/assets/fonts/Rinjani.otf' | relative_url }}" as="font" type="font/otf" crossorigin>
    <link rel="preload" href="{{ '/assets/fonts/RinjaniSemibold.otf' | relative_url }}" as="font" type="font/otf" crossorigin>
    <!-- Preload profile image -->
    <link rel="preload" href="{{ '/assets/images/profile.jpg' | relative_url }}" as="image">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <button class="hamburger" id="hamburger" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="{{ '/' | relative_url }}" class="nav-brand">Krupa Patel</a>
                <div class="nav-links">
                    <a href="{{ '/' | relative_url }}#projects">Projects</a>
                    <a href="{{ '/' | relative_url }}#resume">Resume</a>
                </div>
            </nav>
        </div>
    </header>
    
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-content">
            <button class="mobile-menu-close" id="mobile-menu-close">&times;</button>
            <a href="{{ '/' | relative_url }}#projects" class="mobile-menu-link">Projects</a>
            <a href="{{ '/' | relative_url }}#resume" class="mobile-menu-link">Resume</a>
        </div>
    </div>
    <div class="page-container">
        <div class="page-content">
            {{ content }}
        </div>
    </div>
    
    <script>
        // Dynamic navbar height calculation for hero positioning
        function updateNavbarHeight() {
            const header = document.querySelector('.header');
            if (header) {
                const headerHeight = header.offsetHeight;
                document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
            }
        }
        
        // Update on load and resize
        window.addEventListener('load', updateNavbarHeight);
        window.addEventListener('resize', updateNavbarHeight);
        // Update immediately
        updateNavbarHeight();

        // Mobile menu toggle
        const hamburger = document.getElementById('hamburger');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');
        
        // Open menu
        hamburger.addEventListener('click', () => {
            mobileMenu.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
        });
        
        // Close menu
        mobileMenuClose.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        });
        
        // Close menu when clicking a link
        mobileMenuLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
            });
        });
        
        // Close menu when clicking outside
        mobileMenu.addEventListener('click', (e) => {
            if (e.target === mobileMenu) {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Mobile touch-triggered animations
        function initTouchAnimations() {
            // Only run on mobile devices (touch devices without hover)
            const isMobile = !window.matchMedia('(hover: hover)').matches && 
                           window.matchMedia('(pointer: coarse)').matches;
            
            if (!isMobile) return;
            
            // Development logging (only on localhost)
            const isDev = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            if (isDev) console.log('Mobile touch animations initialized');
            
            // Get all animatable elements
            const projectCards = document.querySelectorAll('.project-card');
            const heroButtons = document.querySelectorAll('.hero-buttons .btn-primary');
            const profileImage = document.querySelector('.hero-right .image-wrapper');
            
            // Collect all animatable elements
            const allAnimatableElements = [
                ...projectCards,
                ...heroButtons,
                ...(profileImage ? [profileImage] : [])
            ];
            
            if (isDev) console.log('Found', allAnimatableElements.length, 'animatable elements');
            
            // Function to reset all animations
            function resetAllAnimations() {
                allAnimatableElements.forEach(element => {
                    element.classList.remove('touch-active');
                });
            }
            
            // Add touch listeners to each animatable element
            allAnimatableElements.forEach((element, index) => {
                element.addEventListener('touchstart', (e) => {
                    e.stopPropagation(); // Prevent document touchstart
                    if (isDev) console.log('Touch start on element', index);
                    
                    // Reset all other elements first
                    resetAllAnimations();
                    
                    // Then activate this element
                    element.classList.add('touch-active');
                }, { passive: true });
            });
            
            // Document-wide touch listener to reset animations when tapping away
            document.addEventListener('touchstart', (e) => {
                // Only reset if the touch wasn't on an animatable element
                const touchedElement = e.target.closest('.project-card, .btn-primary, .hero-right .image-wrapper');
                if (!touchedElement) {
                    if (isDev) console.log('Tapped away - resetting all animations');
                    resetAllAnimations();
                }
            }, { passive: true });
        }
        
        // Initialize touch animations after DOM is loaded
        document.addEventListener('DOMContentLoaded', initTouchAnimations);

        // Scroll-triggered animations for all sections
        function initScrollAnimations() {
            // Only run on desktop (devices with hover)
            const isDesktop = window.matchMedia('(hover: hover)').matches;
            if (!isDesktop) return;
            
            const animatedElements = document.querySelectorAll('.project-card, .resume-section, .timeline-item, .skill-category');
            
            if (!animatedElements.length) return;
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-in');
                        observer.unobserve(entry.target); // Only animate once
                    }
                });
            }, {
                threshold: 0.1, // Trigger when 10% visible
                rootMargin: '0px 0px -50px 0px' // Start animation 50px before entering viewport
            });
            
            animatedElements.forEach(element => {
                observer.observe(element);
            });
        }
        
        // Initialize scroll animations after DOM is loaded
        document.addEventListener('DOMContentLoaded', initScrollAnimations);

        // Handle browser back/forward button - apply fade in animation
        window.addEventListener('pageshow', (event) => {
            const pageContent = document.querySelector('.page-content');
            if (!pageContent) return;
            
            // Check if coming from back/forward cache or if it's a back/forward navigation
            const navigationEntries = performance.getEntriesByType('navigation');
            const isBackForward = navigationEntries.length > 0 && navigationEntries[0].type === 'back_forward';
            
            if (event.persisted || isBackForward) {
                // Apply fade in animation with same timing as standard navigation
                pageContent.style.transition = 'none';
                pageContent.style.opacity = '0';
                
                // Force reflow
                pageContent.offsetHeight;
                
                // Re-enable transition with same timing as standard navigation
                pageContent.style.transition = 'opacity 0.3s ease-in-out';
                
                // Add slight delay to match standard navigation feel
                setTimeout(() => {
                    pageContent.style.opacity = '1';
                }, 50);
                
                // Clean up after animation
                setTimeout(() => {
                    pageContent.style.transition = '';
                    pageContent.style.opacity = '';
                }, 400);
            }
        });

        // Universal fade-in transitions for all pages
        function initPageTransitions() {
            const pageContent = document.querySelector('.page-content');
            if (!pageContent) return;

            // Check if we should animate based on referrer
            const referrer = document.referrer;
            
            // Check for page refresh using navigation API
            const navigationEntries = performance.getEntriesByType('navigation');
            const isRefresh = navigationEntries.length > 0 && navigationEntries[0].type === 'reload';
            
            // Check legacy refresh detection
            const isLegacyRefresh = performance.navigation && performance.navigation.type === 1;
            
            // Check if this is same-page navigation (e.g., clicking "Krupa Patel" on homepage)
            const isSamePage = referrer && referrer.split('#')[0] === window.location.href.split('#')[0];
            
            // Apply fade-in if coming from ANY page on the same site (not refresh, direct access, or same-page)
            if (referrer && 
                referrer.includes(window.location.hostname) && 
                !isRefresh && 
                !isLegacyRefresh &&
                !isSamePage) {
                
                // Start with fade-in position (invisible)
                pageContent.style.transition = 'none';
                pageContent.style.opacity = '0';
                
                // Force reflow to apply the opacity
                pageContent.offsetHeight;
                
                // Re-enable transition
                pageContent.style.transition = 'opacity 0.3s ease-in-out';
                
                // Fade in smoothly with slight delay for consistency
                setTimeout(() => {
                    pageContent.style.opacity = '1';
                }, 10);
                
                // Clean up after animation
                setTimeout(() => {
                    pageContent.style.transition = '';
                    pageContent.style.opacity = '';
                }, 400);
            }
        }

        // Add universal fade exit animations for all internal navigation
        function initExitAnimations() {
            // Handle clicks on ALL navigation elements
            document.addEventListener('click', (e) => {
                // Check for any clickable element that navigates
                const link = e.target.closest('a');
                const projectCard = e.target.closest('.project-card[data-href]');
                const clickableWithHref = e.target.closest('[data-href]');
                const onclickElement = e.target.closest('[onclick*="location"]');
                
                let href = '';
                
                // Extract href from various sources
                if (link) {
                    href = link.getAttribute('href');
                } else if (projectCard || clickableWithHref) {
                    href = (projectCard || clickableWithHref).getAttribute('data-href');
                } else if (onclickElement) {
                    const onclick = onclickElement.getAttribute('onclick');
                    const match = onclick.match(/(?:window\.)?location(?:\.href)?\s*=\s*['"]([^'"]+)['"]/);
                    if (match) href = match[1];
                }
                
                if (!href) return;
                
                // Skip external links and mailto links
                if (href.startsWith('http') || href.startsWith('mailto:')) return;
                
                // Skip same-page anchor links
                if (href.startsWith('#')) return;
                
                // Also skip anchor links that are to the same page (e.g., /#projects, /krupa-portfolio/#projects)
                if (href.includes('#')) {
                    const [urlPath, anchor] = href.split('#');
                    const currentPath = window.location.pathname;
                    // If the path part matches current page (or is root), treat as same-page anchor
                    if (urlPath === currentPath || urlPath === '' || urlPath === '/') {
                        return;
                    }
                }
                
                // Skip navigation to the same page (e.g., clicking "Krupa Patel" when already on homepage)
                const currentPath = window.location.pathname;
                let targetPath = href;
                
                // Handle relative URLs - convert to absolute path
                if (href.startsWith('./')) {
                    targetPath = href.substring(2);
                } else if (!href.startsWith('/') && !href.startsWith('http')) {
                    targetPath = '/' + href;
                }
                
                // Normalize paths for comparison (remove trailing slashes, handle index.html)
                const normalizePath = (path) => {
                    if (path.endsWith('/')) path = path.slice(0, -1);
                    if (path.endsWith('/index.html')) path = path.replace('/index.html', '');
                    if (path === '') path = '/';
                    return path;
                };
                
                if (normalizePath(currentPath) === normalizePath(targetPath)) {
                    return; // Skip animation for same page navigation
                }
                
                // Apply fade-out to ANY internal page navigation
                const pageContent = document.querySelector('.page-content');
                if (pageContent) {
                    // Prevent default navigation if it's a link
                    if (link) e.preventDefault();
                    
                    // Start fade out animation using inline style
                    pageContent.style.opacity = '0';
                    
                    // Navigate after quick fade out
                    setTimeout(() => {
                        window.location.href = href;
                    }, 200); // Quick fade out
                }
            });
        }

        // Enhanced smooth scrolling for anchor links with navbar offset
        function initSmoothScrolling() {
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return;
                
                const href = link.getAttribute('href');
                if (!href) return;
                
                // Check if it's an anchor link (starts with # or contains #)
                let targetId = '';
                if (href.startsWith('#')) {
                    targetId = href.substring(1);
                } else if (href.includes('#')) {
                    const [urlPath, anchor] = href.split('#');
                    const currentPath = window.location.pathname;
                    // Only handle if it's the same page
                    if (urlPath === currentPath || urlPath === '' || urlPath === '/') {
                        targetId = anchor;
                    }
                }
                
                if (targetId) {
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        e.preventDefault();
                        
                        // Fast, smooth native scroll
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        
                        // Close mobile menu if open
                        const mobileMenu = document.getElementById('mobile-menu');
                        if (mobileMenu && mobileMenu.classList.contains('active')) {
                            mobileMenu.classList.remove('active');
                            document.body.style.overflow = '';
                        }
                    }
                }
            });
        }

        // Initialize fade-in immediately (don't wait for DOMContentLoaded)
        initPageTransitions();
        
        // Initialize exit animations and smooth scrolling after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initExitAnimations();
            initSmoothScrolling();
        });
    </script>
</body>
</html>