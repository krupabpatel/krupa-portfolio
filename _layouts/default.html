<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title | default: site.title }}</title>
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <!-- Preload critical fonts -->
    <link rel="preload" href="{{ '/assets/fonts/Rinjani.otf' | relative_url }}" as="font" type="font/otf" crossorigin>
    <link rel="preload" href="{{ '/assets/fonts/RinjaniSemibold.otf' | relative_url }}" as="font" type="font/otf" crossorigin>
    <!-- Preload profile image -->
    <link rel="preload" href="{{ '/assets/images/profile.jpg' | relative_url }}" as="image">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <button class="hamburger" id="hamburger" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="{{ '/' | relative_url }}" class="nav-brand">Krupa Patel</a>
                <div class="nav-links">
                    <a href="{{ '/' | relative_url }}#projects">Projects</a>
                    <a href="{{ '/' | relative_url }}#contact" class="btn-contact">Book Consultation</a>
                </div>
            </nav>
        </div>
    </header>
    
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-content">
            <button class="mobile-menu-close" id="mobile-menu-close">&times;</button>
            <a href="{{ '/' | relative_url }}#projects" class="mobile-menu-link">Projects</a>
            <a href="{{ '/' | relative_url }}#contact" class="mobile-menu-link">Book Consultation</a>
        </div>
    </div>
    <div class="page-container">
        <div class="page-content">
            {{ content }}
        </div>
    </div>
    
    <script>
        // Dynamic navbar height calculation for hero positioning
        function updateNavbarHeight() {
            const header = document.querySelector('.header');
            if (header) {
                const headerHeight = header.offsetHeight;
                document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
            }
        }
        
        // Update on load and resize
        window.addEventListener('load', updateNavbarHeight);
        window.addEventListener('resize', updateNavbarHeight);
        // Update immediately
        updateNavbarHeight();

        // Mobile menu toggle
        const hamburger = document.getElementById('hamburger');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');
        
        // Open menu
        hamburger.addEventListener('click', () => {
            mobileMenu.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
        });
        
        // Close menu
        mobileMenuClose.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        });
        
        // Close menu when clicking a link
        mobileMenuLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
            });
        });
        
        // Close menu when clicking outside
        mobileMenu.addEventListener('click', (e) => {
            if (e.target === mobileMenu) {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Mobile touch-triggered animations
        function initTouchAnimations() {
            // Only run on mobile devices (touch devices without hover)
            const isMobile = !window.matchMedia('(hover: hover)').matches && 
                           window.matchMedia('(pointer: coarse)').matches;
            
            if (!isMobile) return;
            
            // Development logging (only on localhost)
            const isDev = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            if (isDev) console.log('Mobile touch animations initialized');
            
            // Get all animatable elements
            const projectCards = document.querySelectorAll('.project-card');
            const heroButtons = document.querySelectorAll('.hero-buttons .btn-primary');
            const profileImage = document.querySelector('.hero-right .image-wrapper');
            
            // Collect all animatable elements
            const allAnimatableElements = [
                ...projectCards,
                ...heroButtons,
                ...(profileImage ? [profileImage] : [])
            ];
            
            if (isDev) console.log('Found', allAnimatableElements.length, 'animatable elements');
            
            // Function to reset all animations
            function resetAllAnimations() {
                allAnimatableElements.forEach(element => {
                    element.classList.remove('touch-active');
                });
            }
            
            // Add touch listeners to each animatable element
            allAnimatableElements.forEach((element, index) => {
                element.addEventListener('touchstart', (e) => {
                    e.stopPropagation(); // Prevent document touchstart
                    if (isDev) console.log('Touch start on element', index);
                    
                    // Reset all other elements first
                    resetAllAnimations();
                    
                    // Then activate this element
                    element.classList.add('touch-active');
                }, { passive: true });
            });
            
            // Document-wide touch listener to reset animations when tapping away
            document.addEventListener('touchstart', (e) => {
                // Only reset if the touch wasn't on an animatable element
                const touchedElement = e.target.closest('.project-card, .btn-primary, .hero-right .image-wrapper');
                if (!touchedElement) {
                    if (isDev) console.log('Tapped away - resetting all animations');
                    resetAllAnimations();
                }
            }, { passive: true });
        }
        
        // Initialize touch animations after DOM is loaded
        document.addEventListener('DOMContentLoaded', initTouchAnimations);

        // Page transitions with horizontal slides for page-to-page, clean scrolling for same-page
        function initPageTransitions() {
            const pageContent = document.querySelector('.page-content');
            if (!pageContent) return;

            // Development logging
            const isDev = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            if (isDev) console.log('Page transitions initialized - horizontal slides enabled, vertical slides disabled');

            // Clear all animation classes to prevent conflicts
            function clearAllAnimationClasses() {
                const animationClasses = [
                    'page-slide-enter-from-right',
                    'page-slide-enter-from-left',
                    'page-slide-enter-active',
                    'page-slide-exit-to-left',
                    'page-slide-exit-to-right'
                ];
                
                animationClasses.forEach(cls => {
                    pageContent.classList.remove(cls);
                });
            }

            // Set up page entry animation based on referrer or navigation
            function setupPageEntry() {
                const referrer = document.referrer;
                const currentPath = window.location.pathname;
                
                // Clear any existing animation classes first
                clearAllAnimationClasses();
                
                // Only animate if there's a referrer (coming from another page within the site)
                if (!referrer) {
                    if (isDev) console.log('No referrer - skipping entry animation');
                    return;
                }
                
                // Check if this is a page refresh by looking at navigation type
                if (performance.navigation && performance.navigation.type === 1) {
                    if (isDev) console.log('Page refresh detected - skipping entry animation');
                    return;
                }
                
                // Modern way to detect refresh using Navigation API (fallback)
                if (window.performance.getEntriesByType('navigation')[0]?.type === 'reload') {
                    if (isDev) console.log('Page reload detected - skipping entry animation');
                    return;
                }
                
                try {
                    const referrerURL = new URL(referrer);
                    const referrerPath = referrerURL.pathname;
                    
                    // Only animate if coming from within the same site
                    if (referrerURL.origin !== window.location.origin) {
                        if (isDev) console.log('External referrer - skipping entry animation');
                        return;
                    }
                    
                    // Only animate if actually navigating between different pages
                    if (referrerPath === currentPath) {
                        if (isDev) console.log('Same page - skipping entry animation');
                        return;
                    }
                    
                    // Determine slide direction based on navigation
                    let slideDirection = 'right'; // default: slide from right
                    
                    // If coming from homepage to project page, slide from right
                    if (referrerPath === '/' && currentPath.includes('.html')) {
                        slideDirection = 'right';
                    }
                    // If coming from project page to homepage, slide from left
                    else if (referrerPath.includes('.html') && currentPath === '/') {
                        slideDirection = 'left';
                    }
                    
                    if (isDev) console.log('Applying page entry animation:', slideDirection, 'from referrer:', referrerPath);
                    
                    // Apply entry animation
                    pageContent.classList.add('page-slide-enter-from-' + slideDirection);
                    
                    // Trigger the slide-in animation with a small delay to ensure the initial state is applied
                    requestAnimationFrame(() => {
                        pageContent.classList.remove('page-slide-enter-from-' + slideDirection);
                        pageContent.classList.add('page-slide-enter-active');
                        
                        // Clean up animation classes after animation completes
                        setTimeout(() => {
                            clearAllAnimationClasses();
                            if (isDev) console.log('Animation cleanup completed');
                        }, 450); // Slightly longer than 0.4s animation duration
                    });
                    
                } catch (error) {
                    if (isDev) console.log('Error parsing referrer - skipping entry animation:', error);
                    return;
                }
            }

            // Handle link clicks for smooth transitions
            function handleLinkClick(event) {
                const link = event.target.closest('a');
                if (!link) return;
                
                const href = link.getAttribute('href');
                if (!href) return;
                
                const currentPath = window.location.pathname;
                
                // Check if this is same-page navigation (hash links on current page or root navigation from current page)
                const isSamePage = 
                    // Hash links when already on homepage
                    (href.startsWith('#') && currentPath === '/') ||
                    // Root navigation when already on homepage
                    (href === '/' && currentPath === '/') ||
                    // Hash links that navigate to homepage from homepage
                    (href.startsWith('/#') && currentPath === '/');
                
                if (isSamePage) {
                    if (isDev) console.log('Same-page navigation - letting browser handle naturally:', href);
                    
                    // Let browser handle anchor navigation naturally - no custom scrolling
                    return;
                }
                
                // Only animate for actual page-to-page navigation
                const isPageToPageNavigation = 
                    // Homepage to project page
                    (currentPath === '/' && href.includes('.html')) ||
                    // Project page to homepage
                    (currentPath.includes('.html') && (href === '/' || href.includes('#projects')));
                
                if (!isPageToPageNavigation) {
                    if (isDev) console.log('Not a page-to-page navigation, allowing default behavior for:', href);
                    return; // Let browser handle normally
                }
                
                // Determine slide direction for page-to-page navigation
                let slideDirection = 'left'; // default: slide to left
                
                // If going from homepage to project page, slide to left
                if (currentPath === '/' && href.includes('.html')) {
                    slideDirection = 'left';
                }
                // If going from project page to homepage, slide to right  
                else if (currentPath.includes('.html') && (href === '/' || href.includes('#projects'))) {
                    slideDirection = 'right';
                }
                
                // Let browser handle navigation naturally - entry animation will trigger on new page
                if (isDev) console.log('Page-to-page navigation to', slideDirection, 'for href:', href);
                
                // Don't prevent default - let browser handle the navigation
                // Entry animation will be triggered when the new page loads
            }


            // Set up entry animation on page load
            setupPageEntry();

            // Add click listeners to all navigation links
            document.addEventListener('click', handleLinkClick);
        }

        // Initialize page transitions after DOM is loaded
        document.addEventListener('DOMContentLoaded', initPageTransitions);
    </script>
</body>
</html>